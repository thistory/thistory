---
name: ai-quality
description: AI 대화 품질 최적화 전략. 모델 선택, 프롬프트 설계, 파라미터 튜닝 가이드. AI 관련 코드 수정 시 자동 참조.
user-invocable: true
---

# AI 대화 품질 최적화 전략

This Story 앱의 AI 대화 품질을 최적화하기 위한 가이드.

## 1. 모델 라우팅 전략

태스크별로 최적 모델을 분리한다:

| 태스크 | 모델 | 이유 |
|---|---|---|
| **채팅 (대화)** | `gpt-4.1-mini` | 멀티턴 대화 품질 최고, gpt-4o-mini 대비 instruction following +7%, 지연 50% 감소, 한국어 토큰 30-40% 절약 |
| **인사이트 추출** | `gpt-4o-mini` | JSON Schema 구조화 출력 100% 준수. gpt-4.1은 structured output 미지원 |
| **요약 생성** | `gpt-4.1-nano` | 단순 1문장 요약에 가장 저렴한 모델 충분 |

구현: `src/lib/ai/provider.ts`의 `getModelForTask(config, task)` 함수 사용.

## 2. 생성 파라미터

| 태스크 | temperature | frequencyPenalty | maxOutputTokens |
|---|---|---|---|
| 채팅 | 0.7 | 0.3 | 300 |
| 인사이트 추출 | 0.1 | - | - |
| 요약 | 0.3 | - | 50 |

- `temperature 0.7`: 자연스럽고 다양한 응답. 반복 방지.
- `frequencyPenalty 0.3`: 같은 표현 반복 줄임. 리플렉션 챗봇 핵심 불만 해소.
- `temperature`와 `topP`를 동시에 설정하지 말 것 (충돌).

## 3. 시스템 프롬프트 설계 원칙 (GPT-4.1 최적화)

GPT-4.1은 지시를 **문자 그대로** 따른다. GPT-4o와 다른 프롬프트 전략 필요:

1. **## 섹션 헤딩** 사용하여 구조화
2. **"Do NOT" 규칙 명시적 작성** — 암묵적 규칙은 무시될 수 있음
3. **마지막에 배치된 지시가 우선** — 중요 규칙은 프롬프트 끝에
4. **대문자 강조, 보상/위협 불필요** — 명확하고 구조적인 지시만
5. **예시 문구 금지** — 그대로 복사하므로 "다양하게 표현하라"고 지시

### 프롬프트 구조

```
[역할 정의]
## Response Rules (응답 규칙)
## Conversation Flow (대화 흐름)
## Boundaries (경계/금지사항) ← 마지막에 배치
## Language (언어 지시) ← 최후미
```

### 한국어 지시 (GPT-4.1용 간소화)

```
## Language
Respond entirely in Korean (한국어). Use 해요체 speech level. Do not use any other language.
```

GPT-4.1은 반복 강조 불필요. 간결한 지시가 더 효과적.

## 4. 컨텍스트 윈도우 관리

- 대화 히스토리: **최대 20개 메시지** 캡 (안전장치)
- 5-8 교환 기준 일반적으로 문제 없음
- 이전 인사이트: 최근 5개 (현재 구현 유지)

## 5. 후처리 최적화

인사이트 추출 + 요약 생성은 **대화 종료 시점에 1회만** 실행:
- 메시지 6개 이상 (3왕복) AND 어시스턴트의 마지막 응답이 마무리 패턴 포함
- 또는 메시지 12개 이상 (6왕복, 최대 대화 길이)
- 매 응답마다 실행하면 비용 40-50% 낭비

## 6. 모델 업그레이드 체크리스트

새 모델 도입 시 확인:
- [ ] 한국어 해요체 자연스러운지
- [ ] 질문을 한 번에 하나만 하는지
- [ ] 2-3문장 길이 준수하는지
- [ ] 공감 표현이 자연스러운지
- [ ] 구조화 출력(인사이트 추출) 정상 동작하는지
- [ ] `temperature` 등 파라미터 모델별 조정 필요 여부
